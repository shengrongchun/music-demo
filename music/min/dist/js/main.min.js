function ajaxLyric(e,s){lyricTip("歌词加载中..."),e||s(""),$.ajax({type:"GET",url:"ajaxLyric.do?id="+e,dataType:"json",success:function(e){e.uncollected?console.log("请求参数不正确"):e.lrc&&e.lrc.lyric&&e.lrc.lyric,s(e.lrc.lyric)},error:function(e){console.log("ajax请求错误")}})}function ajaxSheetData(e,s){$.ajax({type:"GET",url:"/sheet.do?id="+e,dataType:"json",success:function(e){s("no resource"==e.msg||404==e.code?"":{name:e.result.name?e.result.name:null,no:e.result.id?e.result.id:null,cover:e.result.coverImgUrl?e.result.coverImgUrl:null,subList:e.result.tracks?e.result.tracks:null})},error:function(e){console.log("ajax请求错误"),srcObj.sheetList.html('<p class="sheetTips">数据加载失败...</p>')}})}function ajaxSearchData(e,s){$.ajax({type:"GET",url:"/search.do?key="+e.key+"&offset="+e.offset+"&type="+e.type+"&limit="+e.limit,dataType:"json",success:function(e){200==e.code&&(srcPlayer.songCount=e.result.songCount,s(e.result.songs))},error:function(e){console.log("ajax请求错误")}})}
var musicList=[{name:"播放历史",item:[]},{name:"sheet表格",item:[{id:3778678},{id:3779629},{id:4395559},{id:64016},{id:112504},{id:19723756},{id:2884035}]},{name:"歌曲列表",item:[]}];
function playerSavedata(i,t){i="srcPlayer_"+i,t=JSON.stringify(t),window.localStorage?localStorage.setItem(i,t):Cookie.write(i,t)}function playerReaddata(i){return i="srcPlayer_"+i,JSON.parse(window.localStorage?localStorage.getItem(i):Cookie.read(i))}function addListhead(){srcObj.mainList.append('<div class="list-item list-head">    <span class="music-album">        专辑    </span>    <span class="auth-name">        演唱者    </span>    <span class="music-name">        歌曲    </span></div>')}function addListbar(i){var t;switch(i){case"more":t='<div class="list-item text-center list-loadmore" title="点击加载更多数据" id="list-foot">点击加载更多...</div>';break;case"nomore":t='<div class="list-item text-center" id="list-foot">没有更多数据了</div>';break;case"loading":t='<div class="list-item text-center" id="list-foot">播放列表加载中...</div>';break;case"nodata":t='<div class="list-item text-center" id="list-foot">未获取到列表数据</div>'}srcObj.mainList.append(t)}function addItem(i,t,a,s){var e='<div class="list-item" data-no="'+(i-1)+'">    <span class="list-num">'+i+'</span>    <span class="music-album">'+s+'</span>    <span class="auth-name">'+a+'</span>    <span class="music-name">'+t+"</span></div>";srcObj.mainList.append(e)}function loadMusicData(i){musicList[srcPlayer.musicList].item=[];for(var t=0,a=i.length;t<a;t++)musicList[srcPlayer.musicList].item.push({musicName:i[t].name,artistsName:i[t].artists[0].name,albumName:i[t].album.name,albumPic:i[t].album.blurPicUrl,musicId:i[t].id,mp3Url:i[t].mp3Url})}function loadMusicList(i){if(srcObj.listNo=i,srcObj.mainList.html(""),0==musicList[i].item.length)return void addListbar("nodata");addListhead(),srcObj.listLength=musicList[i].item.length;for(var t=0;t<srcObj.listLength;t++)addItem(t+1,musicList[i].item[t].musicName,musicList[i].item[t].artistsName,musicList[i].item[t].albumName)}function loadSheet(i){srcObj.noDataId=1;for(var t=0,a=musicList[i].item.length;t<a;t++)ajaxSheetData(musicList[i].item[t].id,loadSheetList)}function initList(){loadMusicList(srcPlayer.musicList),lyricTip(srcPlayer.tips),srcObj.sheetList.html('<p class="sheetTips">数据加载中...</p>'),loadSheet(srcPlayer.sheetList)}function listClick(i,t){if(srcObj.this==t)return void playOrPause();srcObj.this=t,srcObj.no=i,srcObj.play=!0,music_bar.lock(!1),btnPlay(),playShowImg(t),play(musicList[srcObj.listNo].item[i])}function play(i){if("err"==i.mp3Url||!i.mp3Url)return audioErr(),!1;changeCover(i.albumPic),ajaxLyric(i.musicId,lyricCallback),$("audio").remove();var t=$("<audio>").html('<source src="'+i.mp3Url+'">').appendTo("html")[0];t.play(),srcObj.audio=t,putDataHisList(i),"number"==typeof playerReaddata("volume")?srcObj.audio.volume=playerReaddata("volume"):srcObj.audio.volume=srcPlayer.volume,srcObj.audio.addEventListener("timeupdate",updateProgress),srcObj.audio.addEventListener("ended",noBtnNextNusic),$("audio source").on("error",audioErr)}function putDataHisList(i){for(var t=!1,a=0,s=musicList[0].item.length;a<s;a++)if(musicList[0].item[a].musicId==i.musicId)return void(t=!0);t||musicList[0].item.push(i)}function audioErr(){alert("当前歌曲播放失败，自动播放下一首"),lyricTip("当前歌曲播放失败，自动播放下一首"),srcObj.no++,noBtnNextNusic()}function noBtnNextNusic(){srcObj.no+1==srcObj.listLength||srcObj.no+1>srcObj.listLength?(srcObj.audio=void 0,playHideImg(),btnPause(),music_bar.goto(0),music_bar.lock(!0),lyricTip(srcPlayer.tips)):nextMusic()}function updateProgress(){srcObj.play&&(music_bar.goto(srcObj.audio.currentTime/srcObj.audio.duration),scrollLyric(srcObj.audio.currentTime))}function nextMusic(){srcObj.no+1!=srcObj.listLength&&(playHideImg(),btnPause(),music_bar.goto(0),listClick(srcObj.no+1,srcObj.this.next(".list-item")))}function prevMusic(){0!=srcObj.no&&(playHideImg(),btnPause(),music_bar.goto(0),listClick(srcObj.no-1,srcObj.this.prev(".list-item")))}function playShowImg(i){$(".list-playing")&&$(".list-playing").removeClass("list-playing"),i.addClass("list-playing")}function playHideImg(){$(".list-playing")&&$(".list-playing").removeClass("list-playing")}function playOrPause(){srcObj.play?(srcObj.audio&&srcObj.audio.pause(),playHideImg(),btnPause()):srcObj.audio?(srcObj.audio.play(),btnPlay(),playShowImg(srcObj.this)):listClick(0,$(".list-item:eq(1)"))}function btnPlay(){$(".btn-play").addClass("btn-state-paused"),srcObj.play=!0,$(".cover").addClass("turn-on")}function btnPause(){$(".btn-play").removeClass("btn-state-paused"),srcObj.play=!1,$(".cover").removeClass("turn-on")}function playCallback(i){var t=srcObj.audio.duration*i;refreshLyric(t),srcObj.audio.currentTime=t}function volCallback(i){srcObj.audio&&(srcObj.audio.volume=i),0===i?$(".btn-quiet").addClass("btn-state-quiet"):$(".btn-quiet").is(".btn-state-quiet")&&$(".btn-quiet").removeClass("btn-state-quiet"),playerSavedata("volume",i)}function initProgress(){music_bar=new mkpgb("#music-progress",0,playCallback,!0);var i=srcPlayer.volume;volume_bar=new mkpgb("#volume-progress",i,volCallback,!1)}function changeCover(i){i||(i="images/player_cover.png");var t=!1,a=!1;i+="?param=200x200",$("#music-cover").attr("src",i),$("#blur-canvas").fadeOut(1e3),$("#music-cover").load(function(){t?blurCover():a=!0}),$("#blur").animate({opacity:"0.7"},1e3,function(){a?blurCover():t=!0})}function blurCover(){$("#blur-canvas")[0].getContext("2d").drawImage($("#music-cover")[0],10,10,20,20,0,0,$("body").width(),$("body").height()),$("#blur-canvas").fadeIn(1e3),$("#blur").animate({opacity:"0.6"},1500)}function lyricTip(i){lyricArea.html("<li class='lyric-tip'>"+i+"</li>")}function lyricCallback(i){if(srcObj.lyric=parseLyric(i),""===srcObj.lyric)return lyricTip("未获取到歌词"),!1;lyricArea.html(""),lyricArea.scrollLeft(0);var t=0;for(var a in srcObj.lyric){var s=srcObj.lyric[a];s||(s="&nbsp;");var e=$("<li data-no='"+t+"' class='lrc-item'>"+s+"</li>");lyricArea.append(e),t++}}function parseLyric(i){if(""===i)return"";for(var t=i.split("\n"),a={},s=0;s<t.length;s++){var e=decodeURIComponent(t[s]),r=/\[\d*:\d*((\.|\:)\d*)*\]/g,c=e.match(r);if(c)for(var n=e.replace(r,""),l=0,o=c.length;l<o;l++){var u=c[l],m=Number(String(u.match(/\[\d*/i)).slice(1)),d=Number(String(u.match(/\:\d*/i)).slice(1)),b=60*m+d;a[b]=n}}return a}function refreshLyric(i){if(""===srcObj.lyric)return!1;i=parseInt(i);var t=0;for(var a in srcObj.lyric){if(a>=i)break;t=a}scrollLyric(t)}function scrollLyric(i){if(""===srcObj.lyric)return!1;if(i=parseInt(i),void 0===srcObj.lyric||void 0===srcObj.lyric[i])return!1;if(srcObj.lastLyric==i)return!0;var t=0;for(var a in srcObj.lyric){if(a==i)break;t++}srcObj.lastLyric=i,$(".lplaying").removeClass("lplaying"),$(".lrc-item[data-no='"+t+"']").addClass("lplaying");var s=lyricArea.children().height()*t-$(".lyric").height()/2;lyricArea.stop().animate({scrollTop:s},300)}function dataBox(i){switch(i){case"list":$("#main-list").fadeIn(),$("#sheet").fadeOut();break;case"sheet":$("#sheet").fadeIn(),$("#main-list").fadeOut()}}function addSheet(i,t,a){a||(a="img/player_cover.png"),t||(t="读取中..."),a+="?param=200x200";var s='<div class="sheet-item" data-no="'+i+'">    <img class="sheet-cover" src="'+a+'">    <p title='+t+' class="sheet-name">'+t+"</p></div>";srcObj.sheetList.append(s)}function loadSheetList(i){if(1==srcObj.noDataId){srcObj.sheetList.html("");var t={no:"00000000",name:"播放历史",cover:null};addSheet(t.no,t.name,t.cover)}i.name&&(sheetMusicList.push(i),addSheet(i.no,i.name,i.cover)),srcObj.noDataId++}function search(i){srcPlayer.wd=i,ajaxSearchData({key:srcPlayer.wd,offset:srcPlayer.offset,limit:srcPlayer.limit,type:srcPlayer.type},searchCallback)}function searchCallback(i){loadMusicData(i),loadMusicList(srcPlayer.musicList)}mkpgb=function(i,t,a,s){this.bar=i,this.percent=t,this.callback=a,this.locked=s,this.init(this.locked)},mkpgb.prototype={init:function(i){function t(i){if(s){var t;return t=i.clientX<a.minLength?0:i.clientX>a.maxLength?1:(i.clientX-a.minLength)/(a.maxLength-a.minLength),a.callback(t),a.goto(t),!0}}var a=this,s=!1;return a.lock(i),$(a.bar).html('<div class="mkpgb-bar"></div><div class="mkpgb-cur"></div><div class="mkpgb-dot"></div>'),a.minLength=$(a.bar).offset().left,a.maxLength=$(a.bar).width()+a.minLength,$(window).resize(function(){a.minLength=$(a.bar).offset().left,a.maxLength=$(a.bar).width()+a.minLength}),$(a.bar+" .mkpgb-dot").mousedown(function(i){i.preventDefault()}),$(a.bar).mousedown(function(i){a.locked||(s=!0),t(i)}),$("html").mousemove(function(i){t(i)}),$("html").mouseup(function(i){s=!1}),a.goto(a.percent),!0},goto:function(i){return i>1&&(i=1),i<0&&(i=0),this.percent=i,$(this.bar+" .mkpgb-dot").css("left",100*i+"%"),$(this.bar+" .mkpgb-cur").stop().animate({width:100*i+"%"},20),!0},lock:function(i){if(i)this.locked=!0,$(this.bar).addClass("mkpgb-locked");else{if(!this.locked)return;this.locked=!1,$(this.bar).removeClass("mkpgb-locked")}return!0}};var lyricArea=$("#lyric");
var srcPlayer={wd:"张国荣",volume:.5,tips:"欢迎使用骚贱音乐",limit:20,type:1,offset:0,musicList:2,sheetList:1},srcObj=[],sheetMusicList=[];$(function(){$(".btn").click(function(){switch($(this).data("action")){case"search":$("#btn-area").hide(),$("#search-area").fadeIn(),$("#search-wd").val(srcPlayer.wd),$("#search-wd").focus(),$("#search-wd").select();break;case"list":$(this).hasClass("active")||($(".btn").removeClass("active"),$(this).addClass("active")),dataBox("list");break;case"sheet":$(this).hasClass("active")||($(".btn").removeClass("active"),$(this).addClass("active")),dataBox("sheet")}}),$(".search-close").click(function(){$("#btn-area").fadeIn(),$("#search-area").hide()}),$("#search-wd").bind("keydown",function(t){13==t.keyCode&&$(".search-submit").click()}),$(".search-submit").click(function(){var t=$("#search-wd").val();if(!t)return alert("搜索内容不能为空"),!1;search(t),$(".btn").removeClass("active"),$(".btn[data-action='list']").addClass("active"),dataBox("list")}),$(".music-list").on("mousemove",".list-item",function(){var t=parseInt($(this).data("no"));if(isNaN(t))return!1;if(!$(this).data("loadmenu")){var a=$(this).find(".music-name"),s='<span class="music-name-cult">'+a.html()+'</span><div class="list-menu" data-no="'+t+'"><span class="list-icon icon-play" data-function="play" title="点击播放这首歌"></span><span class="list-icon icon-download" data-function="download" title="点击下载这首歌"></span><span class="list-icon icon-share" data-function="share" title="点击分享这首歌"></span></div>';a.html(s),$(this).data("loadmenu",!0)}}),$(".music-list").on("dblclick",".list-item",function(){var t=parseInt($(this).data("no"));if(isNaN(t))return!1;listClick(t,$(this))}),$(".music-list").on("click",".icon-play,.icon-download,.icon-share",function(){var t=parseInt($(this).parent().data("no"));if(isNaN(t))return!1;switch($(this).data("function")){case"play":listClick(t,$(this).closest(".list-item"))}return!0}),$(".btn-play").click(function(t){playOrPause()}),$(".btn-prev").click(function(){prevMusic()}),$(".btn-next").click(function(){nextMusic()}),$(".btn-quiet").click(function(){0==volume_bar.percent?("number"!=typeof srcObj.defaultVol&&(srcObj.defaultVol=srcPlayer.volume),volCallback(srcObj.defaultVol),volume_bar.goto(srcObj.defaultVol)):("number"==typeof playerReaddata("volume")?srcObj.defaultVol=playerReaddata("volume"):srcObj.defaultVol=srcPlayer.volume,volCallback(0),volume_bar.goto(0))}),$("#main-list,#sheet").mCustomScrollbar({theme:"minimal",advanced:{updateOnContentResize:!0}}),srcObj.sheetList=$("#sheet .mCSB_container"),srcObj.mainList=$("#main-list .mCSB_container"),$("#sheet").on("click",".sheet-cover,.sheet-name",function(){$(".btn[data-action='sheet']").removeClass("active"),$(".btn[data-action='list']").addClass("active"),dataBox("list");var t=parseInt($(this).parent().data("no"));if(0==t)return $(".btn[data-action='list']")[0].innerText="播放历史",void loadMusicList(0);$(".btn[data-action='list']")[0].innerText="歌曲列表";for(var a=0,s=sheetMusicList.length;a<s;a++)if(sheetMusicList[a].no==t)return loadMusicData(sheetMusicList[a].subList),void loadMusicList(srcPlayer.musicList)}),addListbar("loading"),initList(),initProgress()});